import jsPDF from 'jspdf';

const AGREEMENT_TEXTS = {
    'content-release': `
CONTENT RELEASE AGREEMENT

This Content Release Agreement (“Agreement”) is entered into on the date of signature below.

1. Grant of Rights: The undersigned (“Releasor”) hereby grants to the other undersigned party (“Releasee”) the irrevocable right and permission to use, reproduce, publish, distribute, broadcast, display, and otherwise exploit any and all photographs, video recordings, audio recordings, written statements, likenesses, images, or other media content (collectively, the “Content”) in which the Releasor appears or is identifiable. This includes use in any media now known or later developed, including but not limited to print, television, radio, film, digital, social media, advertising, promotional materials, and merchandise.

2. Scope of Use: The rights granted herein are worldwide, perpetual, royalty-free, and may be assigned, transferred, or sublicensed by the Releasee at their discretion. The Releasee may edit, alter, crop, combine, or otherwise modify the Content without restriction and without obligation to notify or seek additional approval from the Releasor.

3. Compensation: The Releasor acknowledges that they are providing this release voluntarily and that any compensation, if provided, is the full and final consideration for the rights granted herein. No further payments or royalties will be due in connection with any use of the Content.

4. Waiver of Claims: The Releasor waives any right to inspect or approve the final product, its use, or any accompanying text or material. The Releasor releases and discharges the Releasee from any and all claims, demands, or causes of action that the Releasor may have now or in the future, including but not limited to claims for defamation, invasion of privacy, infringement of moral rights, or violation of any publicity or personality rights arising out of or in connection with the use of the Content.

5. Legal Capacity: The Releasor affirms that they are at least 18 years of age and have the full legal capacity to execute this Agreement. If under 18, the signature of a parent or legal guardian is required.

6. Entire Agreement: This document constitutes the entire agreement between the parties regarding the Content and supersedes any prior understandings or agreements, whether written or oral, concerning the subject matter herein. No amendment or modification shall be valid unless made in writing and signed by both parties.

7. Governing Law: This Agreement shall be governed by and construed in accordance with the laws of the jurisdiction in which it is executed, without regard to its conflict of laws principles.
    `,
    'general-consent': `
SEXUAL CONSENT AGREEMENT

This Sexual Consent Agreement (“Agreement”) is entered into on the date of signature below. The undersigned individuals (collectively, “the Parties”) voluntarily and knowingly agree to the following terms:

1. Voluntary Participation: Both Parties confirm that their participation in any sexual contact or activity is completely voluntary, free from any form of force, pressure, manipulation, intimidation, blackmail, or undue influence. Neither Party has been threatened, bribed, or promised any form of reward or benefit in exchange for participation.

2. Capacity and State of Mind: Both Parties affirm that, at the time of signing and during all agreed activities: They are of legal age to consent under the laws of the jurisdiction where this Agreement is executed. They are of sound mind and mental capacity to fully understand and agree to these terms. They are not under the influence of alcohol, drugs, medication, or any impairing substance to an extent that affects judgment, comprehension, or decision-making ability. They have had adequate time to consider the implications of engaging in sexual activity and to ask any questions before signing.

3. Understanding of Consent: The Parties acknowledge that: Consent must be informed, freely given, mutual, and ongoing. Consent can be withdrawn by either Party at any time, for any reason, without explanation. Withdrawal of consent requires the other Party to immediately cease all activity, without delay or argument. Past participation in sexual activity with each other or with others does not imply or guarantee consent for future activities.

4. Boundaries and Respect: The Parties agree to communicate clearly regarding comfort levels, physical boundaries, emotional boundaries, and any other personal limits before and during activities. Both Parties commit to: Respecting verbal and non-verbal cues that indicate discomfort, reluctance, or withdrawal of consent. Avoiding actions that are known, reasonably suspected, or observed to cause undue distress, injury, or emotional harm. Honoring the personal dignity, privacy, and physical safety of the other Party at all times.

5. Health and Safety: The Parties confirm that: They have disclosed any relevant health conditions, including sexually transmitted infections (STIs) or diseases, that may reasonably impact the other Party’s decision to participate. They have discussed and mutually agreed upon any precautionary measures to be used during activities, including protection and hygiene standards. They will immediately inform the other Party if, at any time, they experience discomfort, pain, distress, or any medical concern during the encounter.

6. No Exploitation or Public Exposure: The Parties agree that: No recording (audio, video, or photographic) of any sexual activity will occur without clear, mutual agreement at the time of recording. If any recording is made, the use, storage, and sharing of that recording must be agreed upon in writing. No content, information, or personal details about the other Party will be shared publicly, online, or with third parties without express consent.

7. Duration of Consent: This Agreement covers only the specific sexual activities engaged in during the timeframe immediately following its execution. It does not grant open-ended or perpetual consent for future encounters. Any subsequent activities will require renewed verbal or written consent.

8. Mutual Release: Provided that all activities remain within the agreed boundaries and all withdrawal of consent is respected immediately, each Party releases the other from liability for claims, complaints, or disputes arising from the consensual nature of the encounter.

9. Legal Limitations: Both Parties understand that: This Agreement does not waive or override any applicable laws regarding sexual assault, statutory rape, or incapacity to consent. If one Party is later determined to have been unable to legally or mentally consent at the time of the encounter, this Agreement is void. Any violation of the terms of this Agreement, including failure to respect withdrawal of consent, nullifies its protections for the violating Party.

10. Entire Understanding: This Agreement reflects the entire understanding between the Parties regarding the encounter it covers. It cannot be altered except in writing signed by both Parties before activities take place.
    `,
    'nda': `
NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement (“Agreement”) is entered into on the date of signature below.

The undersigned individuals or entities (collectively, “the Parties”) voluntarily and knowingly agree to the following terms:

1. Purpose: The Parties intend to engage in discussions, share information, or work together in a manner that may involve the disclosure of confidential, proprietary, or otherwise sensitive information (“Confidential Information”). This Agreement sets out the obligations of each Party to maintain the confidentiality of such information.

2. Definition of Confidential Information: For the purposes of this Agreement, “Confidential Information” includes, without limitation: Any written, verbal, electronic, or visual information not generally known to the public. Business strategies, marketing plans, pricing structures, contracts, agreements, and financial records. Product designs, concepts, prototypes, formulas, code, source files, and technical data. Customer lists, supplier relationships, sales records, lead data, and trade secrets. Any discussions, proposals, or negotiations between the Parties. Any other information identified as confidential at the time of disclosure or that should reasonably be understood as confidential given the nature of the information.

3. Exclusions from Confidential Information: Confidential Information does not include information that: Is or becomes publicly available through no fault of the receiving Party. Was lawfully known to the receiving Party before disclosure by the other Party. Is lawfully obtained from a third party without breach of any obligation of confidentiality. Is independently developed by the receiving Party without reference to the Confidential Information.

4. Obligations of Confidentiality: Each Party agrees to: Keep all Confidential Information strictly confidential and not disclose it to any third party without prior written consent from the disclosing Party. Use the Confidential Information solely for the purposes expressly agreed upon by the Parties. Take all reasonable measures to protect the secrecy and prevent unauthorized use or disclosure of Confidential Information. Restrict disclosure of Confidential Information to only those employees, contractors, or representatives who have a legitimate need to know and are bound by confidentiality obligations no less strict than those contained in this Agreement.

5. Non-Use and Non-Competition: Unless otherwise agreed in writing: The receiving Party shall not use the Confidential Information for their own benefit or the benefit of any third party outside the agreed scope. The receiving Party shall not use the Confidential Information to compete directly or indirectly with the disclosing Party’s business, products, or services for a reasonable period of time following the date of this Agreement.

6. Return or Destruction of Materials: Upon request by the disclosing Party or termination of the Parties’ relationship, the receiving Party shall promptly return or destroy all copies, notes, summaries, or other materials containing Confidential Information, in any format, and confirm in writing that such return or destruction has been completed.

7. Duration of Confidentiality: The obligations of this Agreement shall remain in effect indefinitely from the date of signature, unless otherwise required by law, and will survive the termination of any business relationship between the Parties.

8. Remedies for Breach: The Parties agree that any unauthorized disclosure or use of Confidential Information may cause irreparable harm, for which monetary damages may be insufficient. In such cases, the disclosing Party is entitled to seek injunctive relief, specific performance, and any other remedies available at law or in equity, without the necessity of posting bond or proving actual damages.

9. Legal Compliance: Nothing in this Agreement shall prohibit disclosure of Confidential Information if required by law, regulation, court order, or government authority, provided that the receiving Party gives prompt notice to the disclosing Party to allow them to seek protective measures.

10. Entire Agreement: This Agreement constitutes the entire understanding between the Parties regarding confidentiality and supersedes all prior discussions, understandings, or agreements, whether written or oral, relating to the subject matter herein. Any modification must be made in writing and signed by both Parties.
    `
};

const formTitles = {
  'content-release': 'Content Release Form',
  'general-consent': 'Sexual Consent Form',
  'nda': 'Non-Disclosure Agreement'
};

const sanitizeString = (str) => {
  if (str === null || str === undefined) return '';
  return String(str);
};

const formatFieldLabel = (key) => {
  return sanitizeString(key)
    .replace(/([A-Z])/g, ' $1')
    .replace(/^./, str => str.toUpperCase())
    .replace(/Id$/, 'ID');
};

export const generatePdf = async (
  formType,
  formData,
  signatures,
  t,
  asBlob = false
) => {
  const doc = new jsPDF({
    orientation: 'p',
    unit: 'mm',
    format: 'a4'
  });

  let y = 15;
  const pageHeight = doc.internal.pageSize.height;
  const margin = 15;
  const contentWidth = doc.internal.pageSize.width - (margin * 2);

  const checkAndAddPage = (requiredHeight) => {
    if (y + requiredHeight > pageHeight - margin) {
      doc.addPage();
      y = margin;
    }
  };

  // Title
  const fallbackTitle = formTitles[formType] || 'Completed Form';
  const titleText = t ? (t(`form.${formType}.title`) || fallbackTitle) : fallbackTitle;

  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(titleText, margin, y);
  y += 10;

  // Summary heading
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('SUMMARY OF DETAILS', margin, y);
  y += 8;
  doc.setLineWidth(0.5);
  doc.line(margin, y - 4, margin + contentWidth, y - 4);

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);

  // Fields
  for (const [key, value] of Object.entries(formData || {})) {
    if (key === 'idPhoto' || key === 'releasors' || key === 'releasee' || key === 'participants') continue;
    checkAndAddPage(6);
    doc.setFont('helvetica', 'bold');
    doc.text(`${formatFieldLabel(key)}:`, margin, y);
    doc.setFont('helvetica', 'normal');
    const val = typeof value === 'boolean' ? (value ? 'Yes' : 'No') : (sanitizeString(value) || 'N/A');
    const splitVal = doc.splitTextToSize(val, contentWidth - 55);
    doc.text(splitVal, margin + 50, y);
    y += (splitVal.length * 5) + 1;
  }

  const renderPartyInfo = (party, title) => {
    if (!party) return;
    checkAndAddPage(20);
    y += 4;
    doc.setFont('helvetica', 'bold');
    doc.text(title, margin, y);
    y += 6;
    doc.setFont('helvetica', 'normal');
    const name = party.name || `${sanitizeString(party.firstName)} ${sanitizeString(party.lastName)}`;
    doc.text(`Name: ${name.trim() || 'N/A'}`, margin + 5, y);
    y += 5;
    doc.text(`Email: ${sanitizeString(party.email) || 'N/A'}`, margin + 5, y);
    y += 5;
  };

  if (formData?.releasors) formData.releasors.forEach((p, i) => renderPartyInfo(p, `Releasor #${i + 1}`));
  if (formData?.releasee) renderPartyInfo(formData.releasee, 'Releasee');
  if (formData?.participants) formData.participants.forEach((p, i) => renderPartyInfo(p, `Party #${i + 1}`));

  if (formData?.idPhoto && formData.idPhoto.dataUrl) {
    checkAndAddPage(60);
    y += 4;
    doc.setFont('helvetica', 'bold');
    doc.text('ID Photo:', margin, y);
    y += 5;
    try {
      const format = formData.idPhoto.dataUrl.split(';')[0].split('/')[1].toUpperCase();
      doc.addImage(formData.idPhoto.dataUrl, format, margin, y, 80, 50);
      y += 55;
    } catch (e) {
      console.error("Error adding ID image to PDF:", e);
      doc.text('Could not load ID image.', margin, y);
      y += 5;
    }
  }

  // AGREEMENT section
  checkAndAddPage(20);
  y += 10;
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('AGREEMENT', margin, y);
  y += 8;
  doc.setLineWidth(0.5);
  doc.line(margin, y - 4, margin + contentWidth, y - 4);

  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  const agreementText = AGREEMENT_TEXTS[formType] || 'No agreement text available.';
  const splitText = doc.splitTextToSize(agreementText.trim(), contentWidth);

  splitText.forEach(line => {
    checkAndAddPage(4);
    doc.text(line, margin, y);
    y += 4;
  });

  // SIGNATURES
  checkAndAddPage(20);
  y += 10;
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('SIGNATURES', margin, y);
  y += 8;
  doc.setLineWidth(0.5);
  doc.line(margin, y - 4, margin + contentWidth, y - 4);
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text(`Signed on: ${sanitizeString(signatures?.date)}`, margin, y);
  y += 8;

  const addSignature = (label, sigSrc) => {
    if (!sigSrc) return;
    checkAndAddPage(40);
    doc.setFont('helvetica', 'bold');
    doc.text(label, margin, y);
    y += 5;
    try {
      doc.addImage(sigSrc, 'PNG', margin, y, 60, 30);
      y += 35;
    } catch (e) {
      console.error(`Error adding ${label} to PDF:`, e);
      doc.text(`Could not load ${label}.`, margin, y);
      y += 5;
    }
  };

  if (signatures?.releasorSignature) addSignature('Releasor Signature:', signatures.releasorSignature);
  if (signatures?.releaseeSignature) addSignature('Releasee Signature:', signatures.releaseeSignature);
  if (signatures?.participantSignatures) {
    signatures.participantSignatures.forEach((sig, i) =>
      addSignature(`Party #${i + 1} Signature:`, sig)
    );
  }
  if (signatures?.participant) addSignature('Participant Signature:', signatures.participant.signature);

  const fileName = `${formType}-agreement-${new Date().toISOString().split('T')[0]}.pdf`;

  if (asBlob) {
    // ✅ return Blob for uploads / manual download
    return doc.output('blob');
  } else {
    // ✅ old behaviour: trigger browser download
    doc.save(fileName);
    return null;
  }
};